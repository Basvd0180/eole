"use strict";(self.webpackChunkdocusaurus_tsx=self.webpackChunkdocusaurus_tsx||[]).push([[2492],{2879:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>a,contentTitle:()=>l,default:()=>h,frontMatter:()=>o,metadata:()=>i,toc:()=>c});var t=s(4848),r=s(8453);const o={},l="How can I create custom on-the-fly data transforms?",i={id:"FAQ/custom_transforms",title:"How can I create custom on-the-fly data transforms?",description:"The code is easily extendable with custom transforms inheriting from the Transform base class.",source:"@site/docs/FAQ/custom_transforms.md",sourceDirName:"FAQ",slug:"/FAQ/custom_transforms",permalink:"/eole/docs/FAQ/custom_transforms",draft:!1,unlisted:!1,editUrl:"https://github.com/eole-nlp/eole/tree/main/docs/docs/FAQ/custom_transforms.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Frequently Asked Questions",permalink:"/eole/docs/category/frequently-asked-questions"},next:{title:"Do you support multi-gpu?",permalink:"/eole/docs/FAQ/distributed"}},a={},c=[];function d(e){const n={code:"code",h1:"h1",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"how-can-i-create-custom-on-the-fly-data-transforms",children:"How can I create custom on-the-fly data transforms?"}),"\n",(0,t.jsxs)(n.p,{children:["The code is easily extendable with custom transforms inheriting from the ",(0,t.jsx)(n.code,{children:"Transform"})," base class."]}),"\n",(0,t.jsxs)(n.p,{children:["You can for instance have a look at the ",(0,t.jsx)(n.code,{children:"FilterTooLongTransform"})," and the corresponding ",(0,t.jsx)(n.code,{children:"FilterTooLongConfig"})," classes as a template:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'class FilterTooLongConfig(TransformConfig):\n    src_seq_length: int | None = Field(\n        default=192, description="Maximum source sequence length."\n    )\n    tgt_seq_length: int | None = Field(\n        default=192, description="Maximum target sequence length."\n    )\n\n...\n\n@register_transform(name="filtertoolong")\nclass FilterTooLongTransform(Transform):\n    """Filter out sentence that are too long."""\n\n    config_model = FilterTooLongConfig\n\n    def __init__(self, config):\n        super().__init__(config)\n\n    def _parse_config(self):\n        self.src_seq_length = self.config.src_seq_length\n        self.tgt_seq_length = self.config.tgt_seq_length\n\n    def apply(self, example, is_train=False, stats=None, **kwargs):\n        """Return None if too long else return as is."""\n        if len(example["src"]) > self.src_seq_length or (\n            example["tgt"] is not None and len(example["tgt"]) > self.tgt_seq_length - 2\n        ):\n            if stats is not None:\n                stats.update(FilterTooLongStats())\n            return None\n        else:\n            return example\n\n    def _repr_args(self):\n        """Return str represent key arguments for class."""\n        return "{}={}, {}={}".format(\n            "src_seq_length", self.src_seq_length, "tgt_seq_length", self.tgt_seq_length\n        )\n'})}),"\n",(0,t.jsx)(n.p,{children:"Methods:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"_parse_opts"})," allows to parse options from the ",(0,t.jsx)(n.code,{children:"config_model"}),";"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"apply"})," is where the transform happens;"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"_repr_args"})," is for clean logging purposes."]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["As you can see, there is the ",(0,t.jsx)(n.code,{children:"@register_transform"})," wrapper before the class definition. This will allow for the class to be automatically detected (if put in the proper ",(0,t.jsx)(n.code,{children:"transforms"})," folder) and usable in your training configurations through its ",(0,t.jsx)(n.code,{children:"name"})," argument."]}),"\n",(0,t.jsxs)(n.p,{children:["You could also collect statistics for your custom transform by creating a class inheriting ",(0,t.jsx)(n.code,{children:"ObservableStats"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'class FilterTooLongStats(ObservableStats):\n    """Runing statistics for FilterTooLongTransform."""\n    __slots__ = ["filtered"]\n\n    def __init__(self):\n        self.filtered = 1\n\n    def update(self, other: "FilterTooLongStats"):\n        self.filtered += other.filtered\n'})}),"\n",(0,t.jsx)(n.p,{children:"NOTE:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Add elements to keep track in the ",(0,t.jsx)(n.code,{children:"__init__"})," and also ",(0,t.jsx)(n.code,{children:"__slot__"})," to make it lightweight;"]}),"\n",(0,t.jsxs)(n.li,{children:["Supply update logic in ",(0,t.jsx)(n.code,{children:"update"})," method;"]}),"\n",(0,t.jsxs)(n.li,{children:["(Optional) override ",(0,t.jsx)(n.code,{children:"__str__"})," to change default log message format;"]}),"\n",(0,t.jsxs)(n.li,{children:["Instantiate and passing the statistic object in the ",(0,t.jsx)(n.code,{children:"apply"})," method of the corresponding transform class;"]}),"\n",(0,t.jsx)(n.li,{children:"statistics will be gathered per corpus per worker, but only first worker will report for its shard by default."}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"example"})," argument of ",(0,t.jsx)(n.code,{children:"apply"})," is a ",(0,t.jsx)(n.code,{children:"dict"})," of the form:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'{\n\t"src": <source string>,\n\t"tgt": <target string>,\n\t"align": <alignment pharaoh string> # optional\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:["This is defined in ",(0,t.jsx)(n.code,{children:"eole.inputters.text_corpus.ParallelCorpus.load"}),". This class is not easily extendable for now but it can be considered for future developments. For instance, we could create some ",(0,t.jsx)(n.code,{children:"CustomParallelCorpus"})," class that would handle other kind of inputs."]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>l,x:()=>i});var t=s(6540);const r={},o=t.createContext(r);function l(e){const n=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),t.createElement(o.Provider,{value:n},e.children)}}}]);